---
title: Corpse System
status: current
last_updated: 2025-11-10
related: [combat-overview, item-system, corpse-mechanics]
---

# Corpse System

The Wumpy corpse system manages the lifecycle of NPC corpses from creation through decay to respawn. When NPCs die in combat, they create lootable corpse containers that decay after a configurable time period, triggering NPC respawn at their original spawn location. The system integrates with combat, containers, loot generation, and timer management.

## Overview

Corpses are specialized containers created automatically when NPCs die. They contain loot generated from the NPC's loot table, remain in the death location for a decay period (default 5 minutes), and trigger NPC respawn upon decay. The system persists timer state across server restarts and supports admin management tools.

The corpse system bridges combat outcomes with the loot economy, providing players with rewards while maintaining world population through respawn mechanics.

## System Architecture

| Component | Purpose | Location |
|-----------|---------|----------|
| **CorpseManager** | Creates and configures corpse containers | `/src/systems/corpses/CorpseManager.js` |
| **TimerManager** | Event-driven timer management for decay | `/src/systems/corpses/TimerManager.js` |
| **RespawnManager** | Handles NPC respawn after decay | `/src/systems/respawn/RespawnManager.js` |
| **ContainerManager** | Underlying container system | `/src/systems/containers/ContainerManager.js` |
| **LootGenerator** | Generates corpse contents | `/src/systems/loot/LootGenerator.js` |
| **Timer Persistence** | State across restarts | Via TimerManager.saveState() |

## Corpse Lifecycle

The complete corpse lifecycle follows this flow:

```
NPC Death (Combat)
    ↓
Generate Loot (LootGenerator)
    ↓
Create Corpse Container (CorpseManager)
    ↓
Register Decay Timer (TimerManager.schedule)
    ↓
Place in Room (World)
    ↓
Player Looting (get/loot commands)
    ↓
Decay Timer Fires (5 minutes, setTimeout)
    ↓
Remove Corpse (CorpseManager.onCorpseDecay)
    ↓
Respawn NPC (RespawnManager)
```

## Corpse Properties

Corpses are containers with additional metadata:

| Property | Type | Purpose | Default |
|----------|------|---------|---------|
| `id` | string | Unique identifier | `corpse_{npcId}_{timestamp}` |
| `name` | string | Display name | `corpse of a {npcName}` |
| `keywords` | string[] | Targeting keywords | `['corpse', 'body', npcId, ...npcName]` |
| `containerType` | string | Type classification | `npc_corpse` |
| `inventory` | Item[] | Loot items | Generated from NPC |
| `capacity` | number | Max items | 20 |
| `weight` | number | Corpse weight (lbs) | Based on NPC size |
| `createdAt` | number | Creation timestamp | `Date.now()` |
| `decayTime` | number | Decay timestamp | `createdAt + 300000` |
| `npcId` | string | Source NPC ID | Original NPC |
| `npcType` | string | NPC type | For categorization |
| `spawnLocation` | string | Respawn room ID | NPC's `spawnLocation` |
| `location` | object | Current location | `{type: 'room', roomId}` |

## Decay and Respawn

### Decay Timer System

The TimerManager provides event-driven decay timing:

| Feature | Implementation | Purpose |
|---------|----------------|---------|
| **Timer Architecture** | setTimeout() per corpse | Event-driven, zero polling overhead |
| **Decay Time** | 5 minutes (300,000ms) | Configurable default |
| **Precision** | Millisecond-accurate | setTimeout precision (not polling) |
| **Persistence** | TimerManager state file | Survive server restarts |
| **Cleanup** | Automatic on expiration | No memory leaks |

### Respawn Mechanics

When a corpse decays, the system triggers NPC respawn:

| Step | Action | Purpose |
|------|--------|---------|
| 1. Remove corpse | Delete from room.containers | Clean up world |
| 2. Delete container | Remove from ContainerManager | Free memory |
| 3. Check spawn location | Verify room exists | Prevent errors |
| 4. Check NPC presence | Avoid duplicates | Prevent double-spawn |
| 5. Add NPC to room | Push to room.npcs | Respawn NPC |
| 6. Reset HP | Set HP to maxHP | Full health respawn |
| 7. Broadcast | Notify nearby players | UX feedback |

## Loot Generation

Corpse contents are generated by the LootGenerator:

| Loot Source | Determination | Example |
|-------------|---------------|---------|
| **NPC Loot Table** | Defined in NPC data | `lootTable: 'goblin_common'` |
| **Challenge Rating** | Currency amount | CR 2 → 10-20 copper |
| **Spawn Tags** | Item filtering | `tags: ['humanoid', 'common']` |
| **Boss Flag** | Enhanced loot | `isBoss: true` → 2x currency |
| **Level Gating** | Rare item qualification | Player level ≥ item level |

Generated items are automatically added to corpse inventory as serialized Item instances.

## Player Interaction

Players interact with corpses through commands:

| Command | Syntax | Purpose |
|---------|--------|---------|
| **look** | `look` | See corpses in room |
| **examine** | `examine corpse` | View contents and decay time |
| **get from** | `get sword from corpse` | Take specific item |
| **get all from** | `get all from corpse` | Take all items |
| **loot** | `loot corpse` | Quick-loot everything |

### Looting Rules

| Rule | Enforcement | Effect |
|------|-------------|--------|
| **Free-for-all** | No ownership | Anyone can loot |
| **Encumbrance** | Weight and slot limits | Prevents over-looting |
| **Stacking** | Automatic for consumables | Saves inventory space |
| **Broadcast** | Room notification | Other players see looting |
| **Empty check** | Auto-message | "Corpse is empty" |

## Integration Points

### Combat Integration

```
CombatEncounter.js (NPC death)
    ↓
CorpseManager.createNPCCorpse(npc, roomId, world)
    ↓
Corpse placed in room.containers[]
    ↓
Message: "A corpse falls to the ground."
```

### Container System

Corpses use the existing ContainerManager infrastructure:
- Container creation and storage
- Inventory management
- Item transfer mechanics
- Capacity enforcement

The corpse system extends containers with decay timers and respawn hooks.

### World System

Rooms track corpses in the `containers` array:

```javascript
room = {
  id: "dungeon_01",
  npcs: ["goblin_warrior"],
  containers: ["corpse_goblin_123"],
  // ...
}
```

Corpses appear in room descriptions and respond to player commands.

## Configuration

Corpse settings are centralized in `/src/config/itemsConfig.js`:

| Setting | Default | Purpose |
|---------|---------|---------|
| `corpses.npc.decayTime` | 300000 (5 min) | Time before decay |
| `corpses.npc.capacity` | 20 | Max items in corpse |
| `corpses.npc.baseWeight` | 100 lbs | Base corpse weight |
| `corpses.npc.isPickupable` | true | Can be picked up |
| `corpses.player.baseWeight` | 150 lbs | Player corpse weight |
| `corpses.player.capacity` | 100 | Max items in player corpse |
| `corpses.player.isPickupable` | false | Cannot be picked up |
| `corpses.player.lootedGracePeriod` | 300000 (5 min) | Cleanup delay after looting |
| `corpses.sizeWeights.tiny` | 10 lbs | Tiny creature weight |
| `corpses.sizeWeights.small` | 50 lbs | Small creature weight |
| `corpses.sizeWeights.medium` | 100 lbs | Medium creature weight |
| `corpses.sizeWeights.large` | 200 lbs | Large creature weight |
| `corpses.sizeWeights.huge` | 500 lbs | Huge creature weight |
| `corpses.sizeWeights.gargantuan` | 1000 lbs | Gargantuan weight |

## Admin Tools

Administrators have special corpse management commands:

| Command | Purpose | Usage |
|---------|---------|-------|
| **@listcorpses** | List all active corpses | `@listcorpses` |
| **@clearcorpses** | Remove corpses in room | `@clearcorpses` |
| **@decaycorpse** | Force corpse decay | `@decaycorpse [id]` |
| **@respawnnpc** | Manually respawn NPC | `@respawnnpc [npcId]` |

## Persistence

The system persists state across server restarts:

| Data | Storage | Format |
|------|---------|--------|
| **Decay Timers** | `/data/corpse_timers.json` | JSON map |
| **Corpse Containers** | In-memory (reconstructed) | From timer data |

**Persistence Flow:**
1. Server shutdown → Save all active timers to JSON
2. Server startup → Load timers from JSON
3. Restore corpse containers from timer metadata
4. Resume decay checking from saved timestamps

## Performance Characteristics

| Metric | Typical Value | Warning Threshold |
|--------|---------------|-------------------|
| Active corpses | 10-50 | > 500 |
| Decay check duration | < 10ms | > 100ms |
| Timer file size | < 50KB | > 1MB |
| Memory per corpse | ~2KB | N/A |
| Check interval | 10 seconds | N/A |

The system is designed to handle hundreds of simultaneous corpses efficiently.

## Implementation Status

| Component | Status | Notes |
|-----------|--------|-------|
| Corpse Creation | Complete | Triggered on NPC death |
| Decay Timer | Complete | 5-minute default, configurable |
| Respawn System | Complete | NPCs respawn at spawn location |
| Looting Commands | Complete | get/loot commands functional |
| Persistence | Complete | Timers saved across restarts |
| Admin Tools | Complete | Management commands available |
| Player Corpses | Planned | Future enhancement |
| Corpse Dragging | Planned | Move corpses between rooms |
| Loot Rights | Planned | Party/owner restrictions |

## Known Limitations

| Limitation | Impact | Workaround |
|------------|--------|------------|
| No player corpses | Players don't drop corpses | Planned for future |
| No corpse movement | Corpses fixed to death room | Use @clearcorpses |
| No loot ownership | Free-for-all looting | Social convention |
| Fixed decay time | All corpses same duration | Configurable per NPC type |

## Common Issues

### Corpse Won't Decay

**Symptoms:** Corpse remains after decay time
**Causes:** Timer not registered, service not running
**Fix:** Check CorpseDecayService initialization in server.js

### NPC Won't Respawn

**Symptoms:** Corpse decays but NPC doesn't return
**Causes:** Missing spawnLocation, NPC already exists
**Fix:** Add spawnLocation to NPC definition, check for duplicates

### Items Disappear from Corpse

**Symptoms:** Looted items not in player inventory
**Causes:** Encumbrance limit exceeded, serialization error
**Fix:** Check weight/slot limits, verify item definitions

## See Also

- [Corpse Mechanics](../mechanics/corpse-mechanics.md) - Detailed decay and respawn mechanics
- [Timer System](timer-system.md) - Event-driven timer architecture (TimerManager)
- [Combat System Overview](combat-overview.md) - How corpses are created
- [Item System Overview](item-system.md) - Loot generation and items
- [Item Loot Reference](../reference/item-loot.md) - Loot table configuration
