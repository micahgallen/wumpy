# Emote System Refactor Plan

## Overview
The current emote implementation centralizes every emote definition and most helper logic in `src/commands/utils.js` and a single `src/commands/emotes/emotes.js` dispatcher. That layout made sense during the initial extraction from the monolith, but it now blocks content authors: adding or updating a single emote requires touching dense shared files, understanding unrelated utilities, and navigating a 200+ line object literal. This plan proposes a modular, template-driven structure that keeps the runtime ergonomics while making emote creation approachable for creators, sheriffs, and admins.

## Goals
- Decouple emote copy from shared utilities so new content does not require editing `utils.js`.
- Provide a clear file-per-emote template with self/target/room perspectives co-located.
- Preserve a single execution path (argument parsing, room broadcasts, taunt rotation) to avoid bugs.
- Add an admin-only scaffolding command that helps privileged roles generate new emote files safely.
- Ship supporting tests and documentation so the pattern is discoverable and regression-safe.

## Current Pain Points
- `src/commands/utils.js:36` stores all emote copy in one object, mixing data with unrelated helpers.
- `src/commands/emotes/emotes.js:12` hard-codes the registration list, so adding an emote means editing two large structures.
- Taunt state, player targeting, and broadcast logic live in `utils.js` which makes test seams awkward.
- Content creators cannot experiment or scaffold new emotes without a developer touching source files.

## Proposed Architecture

### File Layout
```
src/commands/emotes/
├── createEmote.js          # Factory that builds command descriptors
├── emoteUtils.js           # Shared helpers (find target, broadcast, taunt index helpers)
├── registry.js             # Aggregates all emote descriptors for registration
├── builtin/
│   ├── applaud.js
│   ├── bow.js
│   └── ... (one file per emote)
└── templates/
    └── emoteTemplate.js    # Reference template exported for tooling/tests

data/emotes/
└── custom/                 # Admin-generated JSON emotes (written by new command)
    └── *.json
```

### Emote Descriptor Factory
- `createEmote(config)` will accept:
  - `name` (string, lowercase command keyword)
  - `aliases` (optional array)
  - `help` (description, usage, examples)
  - `messages.noTarget` & `messages.withTarget`
    - Either static objects (`{ self, room }`) or functions receiving `{ player, target }`.
  - `hooks.beforeExecute` / `hooks.afterExecute` (optional; used for taunt rotation).
- Factory returns a command descriptor with the standard `{ name, aliases, guard, execute, help }` signature, encapsulating:
  - Player/room target resolution.
  - Error messaging for missing targets.
  - Broadcast wiring via `colors.emote`.
  - Optional taunt index updates or other hooks.
- Tests will assert that descriptors generated by the factory conform to expectations and that required message properties are present.

### Shared Helpers Split
- Move emote-specific helpers out of `src/commands/utils.js` into `src/commands/emotes/emoteUtils.js`:
  - `findPlayerInRoom`
  - `broadcastEmote`
  - `cycleTauntIndex` (new helper wrapping taunt rotation)
  - `loadCustomEmotes` (new helper that reads JSON definitions from `data/emotes/custom/` and wraps them via the factory).
- Keep combat/movement helpers in `utils.js` to avoid cross-domain coupling.

### Per-Emote Modules
- Each builtin emote lives in `src/commands/emotes/builtin/<name>.js` and exports the result of `createEmote({ ... })`.
- Copy, aliases, and examples sit next to each other inside the file so creators can clone the template and fill in perspectives quickly.
- Special cases (e.g., `taunt`) use `hooks.afterExecute` to rotate the taunt array without leaking state handling back into the module.

### Emote Registry Aggregator
- New `src/commands/emotes/registry.js`:
  - Imports every builtin module from `builtin/`.
  - Loads any JSON definitions from `data/emotes/custom/` via `loadCustomEmotes`.
  - Exports a simple array of descriptors, enabling `src/commands.js` to register them with a concise loop:
    ```javascript
    const emoteRegistry = require('./commands/emotes/registry');
    emoteRegistry.forEach(descriptor => registry.registerCommand(descriptor));
    ```
- Registry enforces uniqueness by checking names/aliases before returning the list; conflicts throw during server boot to catch mistakes early.

### Admin-Only Emote Scaffolding Command
- Add a new admin command `@createemote` that:
  1. Validates the issuer’s role (Creator, Sheriff, Admin) via `hasPermission`.
  2. Accepts parameters (`name`, optional aliases, self/room/target text) using a structured syntax (e.g., quoted arguments or JSON payload).
  3. Generates a JSON definition under `data/emotes/custom/<name>.json` following the template schema.
  4. Triggers an in-memory reload of custom emotes so the new emote is immediately available without restart.
  5. Writes an audit entry noting issuer, payload, and file path.
- Permission updates:
  - Extend `src/admin/permissions.js` with `Command.CREATEEMOTE`.
  - Map `Command.CREATEEMOTE` to `Role.CREATOR` in `PermissionMatrix` (Sheriff/Admin inherit access).
- Implementation detail:
  - The command will leverage the same validation as the factory (ensure `self`/`room` present, `withTarget` optional keys).
  - If a `target` message is omitted, the command will treat the emote as no-target only.
  - Collision detection prevents overwriting builtin emotes or existing custom files unless `--force` flag is provided.

## Migration Strategy

1. **Extract Helpers**
   - Move emote-specific utilities from `src/commands/utils.js` into `src/commands/emotes/emoteUtils.js`.
   - Update import sites (core emote command, future factory) to use the new module.

2. **Introduce Factory & Registry Skeleton**
   - Add `createEmote.js`, `emoteUtils.js`, and `registry.js` with minimal functionality.
   - Write unit tests covering descriptor structure and helper behavior.

3. **Convert a Pilot Set**
   - Migrate `bow`, `taunt`, and `dance` into the new per-file format.
   - Ensure registration and behavior pass existing tests.
   - Update docs with a how-to-add-emote walkthrough using the pilot files as canonical examples.

4. **Batch Convert Remaining Builtins**
   - Script or manual conversion for the remaining emotes, verifying copy/behavior parity.
   - Remove the legacy `emoteDefinitions` object once all emotes exist as modules.

5. **Hook up Custom Emote Loading**
   - Implement JSON loader, validation, and registry merge.
   - Add schema tests that load fixtures under `tests/fixtures/emotes/`.

6. **Admin Command Implementation**
   - Extend permissions, add the new command handler in `src/admin/commands.js`, and wire it through `chatBinding`.
   - Provide confirmation output showing the generated file path and sample usage lines.
   - Include automated tests simulating Creator/Sheriff/Admin/Player execution.

7. **Documentation & Tooling**
   - Update `src/commands/README.md` and `docs/COMMAND_SYSTEM_ARCHITECTURE.md` with the new structure.
   - Document the JSON schema and the `@createemote` command in `docs/admin/COMMANDS.md` (or equivalent).
   - Optionally provide a CLI scaffold script under `scripts/` for offline generation (mirrors admin command behavior).

8. **Cleanup**
   - Remove unused exports from `src/commands/utils.js`.
   - Delete legacy `src/commands/emotes/emotes.js` after ensuring all references are updated.
   - Run `npm test` and manual smoke commands (`npm run test:interaction`, `node scripts/demo.sh`) to validate behavior.

## Testing & Validation
- **Unit Tests**
  - Factory validation (missing fields, bad aliases, name conflicts).
  - `emoteUtils` helpers with mocked players/context.
  - JSON loader schema validation using malformed fixtures.
- **Integration Tests**
  - Extend existing emote command tests to cover both builtin and custom emotes.
  - New admin command tests verifying permission gating, file creation, reload behavior, and audit logging.
- **Manual**
  - Run the Telnet client, execute a mix of no-target and target emotes, confirm taunt rotation still works.
  - Exercise `@createemote` end-to-end, then restart server to ensure persistence.

## Rollout Considerations
- Deployment must include the new `data/emotes/custom/` directory (writeable by the server process).
- Coordinate with ops to ensure the hosting environment allows runtime file writes or adjust the command to store data via the existing admin persistence layer.
- If hot-reloading custom emotes proves risky, downgrade the command to stage JSON files and require a restart as part of the process; the plan leaves room for this fallback.
- Communicate the new workflow to content teams and update onboarding guides so they know both the manual template path and the admin command flow.
