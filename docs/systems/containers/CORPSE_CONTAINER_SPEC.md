# Corpse Container Specification

**Phase:** 5 - Economy & Loot (Design Only)
**Status:** Deferred for future implementation
**Related:** Container System (`/src/systems/containers/ContainerManager.js`)

## Overview

This document outlines the design for corpse containers - specialized containers that hold loot from defeated NPCs and dead players. Full implementation is deferred until the respawn system is developed.

## Purpose

Corpse containers serve two primary functions:

1. **NPC Corpses:** Temporary containers holding loot dropped by defeated NPCs
2. **Player Corpses:** Containers holding a player's equipment/items on death

## Design Requirements

### NPC Corpses

#### Behavior

- Appear when an NPC is defeated in combat
- Contain loot generated by `LootGenerator` (items + currency)
- Free-for-all loot (first player to loot gets items)
- Decay after a configurable time period (suggest: 5-10 minutes)
- Cannot be moved or taken
- Can be locked (for trapped chests, boss loot, etc.)

#### Data Structure

```javascript
{
  id: "corpse_goblin_123",
  name: "corpse of a goblin",
  description: "The lifeless body of a goblin.",
  keywords: ["corpse", "goblin", "body"],
  containerType: "npc_corpse",
  npcType: "goblin",
  capacity: 20,
  inventory: [...items],  // Generated loot
  currency: 15,           // Copper amount
  isOpen: true,           // Always open
  isLocked: false,
  decayTime: timestamp + 300000,  // 5 minutes
  location: { type: "room", roomId: "dungeon_01" }
}
```

### Player Corpses

#### Behavior

- Created when a player dies
- Contains items that were equipped on death
- Contains percentage of carried currency (configurable, suggest: 10% loss)
- Belongs to the deceased player (only they can loot)
- Persists longer than NPC corpses (suggest: 30 minutes to 24 hours)
- Location persists across server restarts
- May require corpse retrieval quest/mechanic

#### Data Structure

```javascript
{
  id: "corpse_player_alice_456",
  name: "corpse of Alice",
  description: "The lifeless body of Alice.",
  keywords: ["corpse", "alice", "body"],
  containerType: "player_corpse",
  playerName: "alice",
  capacity: Infinity,     // Holds all dropped items
  inventory: [...items],  // Equipped items at death
  currency: 50,           // Lost currency
  isOpen: false,          // Owner must open
  isLocked: false,
  owner: "alice",         // Only owner can loot
  decayTime: timestamp + 1800000,  // 30 minutes
  location: { type: "room", roomId: "dungeon_boss_room" },
  canRetrieve: true       // Can be retrieved/resurrected
}
```

## Integration Points

### With Death System

```javascript
// Pseudocode for player death
function handlePlayerDeath(player) {
  // Create corpse at death location
  const corpse = ContainerManager.createContainer({
    containerType: 'player_corpse',
    playerName: player.username,
    location: { type: 'room', roomId: player.currentRoom }
  });

  // Move equipped items to corpse
  const equippedItems = EquipmentManager.getEquippedItems(player);
  for (const item of equippedItems) {
    EquipmentManager.unequipItem(player, item);
    InventoryManager.removeItem(player, item.instanceId);
    corpse.inventory.push(item);
  }

  // Transfer currency
  const currencyLoss = Math.floor(CurrencyManager.toCopper(player.currency) * 0.10);
  CurrencyManager.removeFromWallet(player, currencyLoss);
  corpse.currency = currencyLoss;

  // Set decay timer
  corpse.decayTime = Date.now() + config.corpse.playerCorpseDecayTime;
}
```

### With Combat System

```javascript
// Pseudocode for NPC death
function handleNPCDeath(npc, room) {
  // Generate loot
  const { items, currency } = LootGenerator.generateNPCLoot(npc);

  // Create corpse
  const corpse = ContainerManager.createContainer({
    containerType: 'npc_corpse',
    name: `corpse of ${npc.name}`,
    npcType: npc.type,
    location: { type: 'room', roomId: room.id },
    inventory: items,
    currency: currency,
    isOpen: true
  });

  // Add to room
  room.containers = room.containers || [];
  room.containers.push(corpse);

  // Schedule decay
  setTimeout(() => {
    ContainerManager.deleteContainer(corpse.id);
    room.containers = room.containers.filter(c => c.id !== corpse.id);
  }, config.corpse.npcCorpseDecayTime);
}
```

### With Respawn System

When the respawn system is implemented:

1. **Player Resurrection:**
   - Player respawns at designated location
   - Corpse remains in death location
   - Player can retrieve corpse (walk back and loot it)
   - Optional: "Retrieve Corpse" spell/ability

2. **Corpse Recovery:**
   - Players can recover their own corpses
   - Items and currency returned to inventory
   - Corpse removed after full recovery

3. **Corpse Decay:**
   - If player doesn't retrieve corpse before decay
   - Items are lost permanently (or sent to a "lost and found")
   - Currency is lost

## Configuration

Suggested configuration in `itemsConfig.js`:

```javascript
corpses: {
  npc: {
    decayTime: 300000,        // 5 minutes (300,000 ms)
    showInRoom: true,
    allowFreeForAll: true
  },
  player: {
    decayTime: 1800000,       // 30 minutes
    currencyLossPercent: 0.10,  // 10% currency lost
    itemsDropped: 'equipped',   // 'all', 'equipped', or 'random'
    allowOthersToLoot: false,   // Only owner can loot
    persistAcrossRestart: true
  }
}
```

## Commands

### For Players

**`loot <corpse>`** - Loot items from a corpse
- Aliases: `take from`, `get from`
- Opens corpse and shows contents
- Takes items from corpse to inventory

**`examine <corpse>`** - Examine corpse contents
- Shows what's in the corpse without looting
- Shows decay time remaining
- Shows owner (for player corpses)

### For Admins

**`@clearcorpses`** - Remove all corpses in room
**`@clearcorpse <id>`** - Remove specific corpse
**`@listcorpses`** - List all corpses on server

## Security Considerations

### Duplication Prevention

1. Corpse items are moved, not copied
2. Items are removed from source before adding to corpse
3. Atomic operations for corpse creation

### Griefing Prevention

1. Player corpses are owned (only owner can loot)
2. NPC corpses are free-for-all (fair distribution)
3. Decay prevents corpse accumulation
4. Admin commands for cleanup

### Edge Cases

1. **Player logs out with corpse:** Corpse persists
2. **Server restart:** Player corpses persist, NPC corpses may decay
3. **Room deleted:** Corpses move to safe location
4. **Owner deleted:** Corpse becomes lootable by anyone after grace period

## Future Enhancements

1. **Corpse Dragging:** Allow players to drag corpses to other rooms
2. **Burial System:** Players can bury corpses for RP or benefits
3. **Necromancy:** Spells/abilities that interact with corpses
4. **Corpse Preservation:** Items that prevent decay
5. **Insurance System:** Players can insure items to auto-recover on death

## Implementation Priority

This feature is deferred pending:

1. **Death System:** Full player death/respawn mechanics
2. **Combat System:** NPC death hooks (partially done in Phase 4)
3. **Room Persistence:** Saving corpse locations
4. **Timer System:** Managing decay timers across restarts

Estimated effort: 2-3 development sessions after prerequisites are complete.

## References

- Container System: `/src/systems/containers/ContainerManager.js`
- Loot Generation: `/src/systems/loot/LootGenerator.js`
- Combat Integration: `/docs/reports/PHASE_4_COMBAT_INTEGRATION_SUMMARY.md`
- Death Durability: `/src/systems/inventory/DeathHandler.js`

## Notes for Implementation

When implementing corpse containers:

1. Extend `ContainerManager` with corpse-specific methods
2. Add corpse decay timer system
3. Integrate with combat resolver NPC death event
4. Integrate with player death handler
5. Add corpse-specific commands
6. Update room serialization to persist corpses
7. Add configuration for corpse behavior
8. Write comprehensive tests for edge cases
9. Document corpse mechanics for players

---

**Status:** Design complete, awaiting respawn system implementation
